name: CI

on:
  pull_request:
  push:
    branches: [master]
  # Allow maintainers to manually kick CI when GitHub doesn't create a run for a new head SHA.
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: python -m pip install --upgrade pip uv

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            backend/.venv
          key: uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install backend dependencies
        run: make backend-sync

      - name: Install frontend dependencies
        run: make frontend-sync

      - name: Run backend checks
        env:
          # Keep CI builds deterministic and secretless.
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          make backend-lint
          make backend-typecheck
          make backend-coverage

      - name: Run frontend checks
        env:
          # Keep CI builds deterministic.
          NEXT_TELEMETRY_DISABLED: "1"
          # Clerk env (wired from repo settings; values are not printed).
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ vars.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_JWKS_URL: ${{ vars.CLERK_JWKS_URL }}
        run: |
          make frontend-lint
          make frontend-typecheck
          make frontend-test
          make frontend-build

      - name: Run Cypress E2E (real Clerk login; no bypass)
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          # next start requires a build output
          start: npm run start -- --port 3000
          wait-on: http://localhost:3000/activity
          wait-on-timeout: 180
        env:
          NEXT_TELEMETRY_DISABLED: "1"
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ vars.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_JWKS_URL: ${{ vars.CLERK_JWKS_URL }}
          # Optional: if the app uses this at runtime
          NEXT_PUBLIC_API_URL: http://localhost:8000

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          if-no-files-found: ignore
          path: |
            backend/coverage.xml
            frontend/coverage/**
