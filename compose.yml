services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL}
      CORS_ORIGINS: ${FRONTEND_URL}
      DB_AUTO_MIGRATE: "true"
      AUTH_MODE: ${AUTH_MODE:-local}
      LOCAL_AUTH_TOKEN: ${LOCAL_AUTH_TOKEN}
      RQ_REDIS_URL: ${REDIS_URL}

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_AUTH_MODE: ${AUTH_MODE:-local}
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_AUTH_MODE: ${AUTH_MODE:-local}

  webhook-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["rq", "worker", "-u", "${REDIS_URL}" ]
    environment:
      DATABASE_URL: ${DATABASE_URL}
      AUTH_MODE: ${AUTH_MODE:-local}
      LOCAL_AUTH_TOKEN: ${LOCAL_AUTH_TOKEN}
      RQ_REDIS_URL: ${REDIS_URL}
      RQ_QUEUE_NAME: default
